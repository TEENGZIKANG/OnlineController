using System.Net;
using System.Text;
using UnityEngine;

public class UnityHttpServer : MonoBehaviour
{
    private HttpListener listener;

    void Start()
    {
        listener = new HttpListener();
        listener.Prefixes.Add("http://+:8080/"); // Listen on all LAN interfaces
        listener.Start();
        listener.BeginGetContext(OnRequest, listener);
        Debug.Log("Unity HTTP Server started on port 8080");
    }

    void OnRequest(IAsyncResult result)
    {
        var context = listener.EndGetContext(result);
        var request = context.Request;
        var response = context.Response;

        // Enable CORS for browser requests
        response.AddHeader("Access-Control-Allow-Origin", "*");

        // Read request body
        string requestBody;
        using (var reader = new System.IO.StreamReader(request.InputStream, request.ContentEncoding))
        {
            requestBody = reader.ReadToEnd();
        }

        Debug.Log("Received: " + requestBody);

        // Send response
        byte[] buffer = Encoding.UTF8.GetBytes("OK");
        response.ContentLength64 = buffer.Length;
        response.OutputStream.Write(buffer, 0, buffer.Length);
        response.OutputStream.Close();

        // Continue listening
        listener.BeginGetContext(OnRequest, listener);
    }

    void OnApplicationQuit()
    {
        listener.Stop();
    }
}
